apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alertmanager@yourdomain.com'
      smtp_auth_username: 'your-email@gmail.com'
      smtp_auth_password: 'your-app-password'
      smtp_require_tls: true
      slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

    route:
      receiver: 'default'
      group_by: ['alertname', 'cluster', 'service', 'severity']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      routes:
        - receiver: 'critical-alerts'
          continue: false
          matchers:
            - severity=~critical
          group_wait: 10s
          group_interval: 5m
          repeat_interval: 3h
        - receiver: 'warning-alerts'
          continue: false
          matchers:
            - severity=~warning
          group_wait: 30s
          group_interval: 10m
          repeat_interval: 6h

    receivers:
      - name: 'default'
        email_configs:
          - to: 'ops-team@yourdomain.com'
            send_resolved: true
            headers:
              Subject: 'Alert: {{ .GroupLabels.alertname }}'

      - name: 'critical-alerts'
        slack_configs:
          - channel: '#alerts-critical'
            send_resolved: true
            title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
            text: '{{ range .Alerts }}*{{ .Labels.alertname }}*: {{ .Annotations.description }}{{ end }}'
            color: 'danger'
        email_configs:
          - to: 'ops-critical@yourdomain.com'
            send_resolved: true
            headers:
              Subject: 'üö® CRITICAL Alert: {{ .GroupLabels.alertname }}'

      - name: 'warning-alerts'
        email_configs:
          - to: 'ops-warning@yourdomain.com'
            send_resolved: true
            headers:
              Subject: '‚ö†Ô∏è Warning Alert: {{ .GroupLabels.alertname }}'
        slack_configs:
          - channel: '#alerts-warning'
            send_resolved: true
            title: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
            text: '{{ range .Alerts }}*{{ .Labels.alertname }}*: {{ .Annotations.description }}{{ end }}'
            color: 'warning'

    inhibit_rules:
      - source_match:
          alertname: 'ApplicationDown'
          severity: 'critical'
        target_match_re:
          severity: 'warning|info'
        equal: ['instance', 'namespace']

---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: spring-boot-alertmanager-config
  namespace: default
spec:
  route:
    receiver: 'default'
    groupBy: ['alertname', 'severity']
    groupWait: 10s
    groupInterval: 10s
    repeatInterval: 12h
    routes:
      - receiver: 'critical-alerts'
        continue: false
        match:
          severity: critical
      - receiver: 'warning-alerts'
        continue: false
        match:
          severity: warning
  receivers:
    - name: 'default'
      emailConfigs:
        - to: 'ops-team@yourdomain.com'
          sendResolved: true
          smarthost: 'smtp.gmail.com:587'
          authUsername: 'your-email@gmail.com'
          authPassword:
            name: alertmanager-secret
            key: smtp-password
          requireTLS: true

    - name: 'critical-alerts'
      slackConfigs:
        - apiURL:
            name: alertmanager-secret
            key: slack-webhook-url
          channel: '#alerts-critical'
          sendResolved: true
          title: 'CRITICAL: {{ .GroupLabels.alertname }}'
          text: '{{ range .Alerts }}*{{ .Labels.alertname }}*: {{ .Annotations.description }}{{ end }}'
      emailConfigs:
        - to: 'ops-critical@yourdomain.com'
          sendResolved: true
          smarthost: 'smtp.gmail.com:587'
          authUsername: 'your-email@gmail.com'
          authPassword:
            name: alertmanager-secret
            key: smtp-password
          requireTLS: true

    - name: 'warning-alerts'
      emailConfigs:
        - to: 'ops-warning@yourdomain.com'
          sendResolved: true
          smarthost: 'smtp.gmail.com:587'
          authUsername: 'your-email@gmail.com'
          authPassword:
            name: alertmanager-secret
            key: smtp-password
          requireTLS: true
      slackConfigs:
        - apiURL:
            name: alertmanager-secret
            key: slack-webhook-url
          channel: '#alerts-warning'
          sendResolved: true
          title: 'WARNING: {{ .GroupLabels.alertname }}'
          text: '{{ range .Alerts }}*{{ .Labels.alertname }}*: {{ .Annotations.description }}{{ end }}'

